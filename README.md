# Users' Guide

LinkedSV is a novel structural variant caller for 10X Genomics (linked-read) sequencing data. It detects deletions, duplications, inversions and translocations using evidence from the barcoded reads. 

## Table of Contents
- [Installation](#Installation)
  - [Prerequisites](#Prerequisites)
  - [Compilation](#Compilation)
- [Usage](#Usage)
  - [General usage](#General_usage)
  - [Use cases](#Use_cases)
- [Output Files](#Output)
  - [SV call file](#SV_call_file)
  - [Intermediate files](#Intermediate_files)
- [Visualization of SV calls](#Visualization)  
- [Citation](#Output)
- [Getting Help](#Getting_Help)

## <a name="Installation"></a>Installation

### <a name="Prerequisites"></a> Prerequisites

Most of the source code was written in Python, but the time-consuming steps were written in C. It uses htslib to process bam files.

The following software tools and packages are required for the installation of LinkedSV. 

1. GCC (version >= 4.4)

2. Python (version: 2.7)

3. Python packages: sklearn, scipy, numpy, gzip, psutil, subprocess, bisect, math, argparse, pandas, seaborn, datetime

You can use `pip` to install a python package. For example, if you want to install sklearn, you can use the following command: 

```
pip install --user sklearn
```

The `--user` tells pip to install the seaborn in your own directory, so that you don't need root access. 

If you don't have `pip` in your system, you can install pip according to the instructions [here](https://pip.pypa.io/en/stable/installing/)

4. [SAMtools](https://github.com/samtools/samtools) (version >= 1.3)

5. [BEDTools](https://bedtools.readthedocs.io/en/latest/)



### <a name="Compilation"></a> Compilation

If the above tools and packages are avaiable, you can use the following command to download and compile LinkedSV: 

```
git clone https://github.com/WGLab/LinkedSV.git 
cd LinkedSV/
sh build.sh 
```


## <a name="Usage"></a>Usage

```
usage: linkedsv.py [-h] -i input.phased_possorted_bam.bam -d output_directory
                   -r ref.fa [-v version] [--gap_region_bed BED]
                   [--black_region_bed BED] [-t num_thread]
                   [--min_fragment_length INT] [--min_reads_in_fragment INT]
                   [--min_supp_barcodes INT] [--samtools path/to/samtools]
                   [--bedtools path/to/bedtools] [--wgs] [--targeted]
                   [--germline_mode] [--somatic_mode] [--target_region BED]
                   [--gap_distance_cut_off INT] [--save_temp_files]

```
## <a name="General_usage"></a>General usage

The `input.phased_possorted_bam.bam` is the input bam file, which contains the barcoded reads. LinkedSV read the barcodes from the `BX` tag in the bam TAG field. We recommend using the `phased_possorted_bam.bam` file generated by the official Longranger pipeline.

The `ref.fasta` file is the FASTA file of the reference genome. It should be the same fasta file that was used for alignment. The `ref.fasta` file should be indexed by samtools. You can use the following command to index a `ref.fasta` file:

```
samtools faidx ref.fasta
```

This command will generate a `ref.fasta.fai` file in the same directory of the `ref.fasta` file. 

`output_directory` is the directory where the output files will be generated. 

`black_region_bed` is the blacklist file for filtering SV calls. The blacklist contains a small set of regions that give consistently spurious signal across samples. We prepared `black_region_bed` for human reference genomes (versions: hg19, b37, hg38), so you don't need to provide it if you use hg19, b37, or hg38. 

`gap_region_bed` is the bed file of gap regions in the reference genome. It is used to filter the SV calls. LinkedSV provides `gap_region_bed` for human reference genomes (versions: hg19, b37, hg38), so you don't need to provide it if you use hg19, b37, or hg38. 

`ref_version` is used to tell LinkedSV which `black_region_bed` file and `gap_region_bed` file should be used. Currently we have generated blacklists for hg19 (style: "chr1"), b37 (style: "1") and hg38 (style: "chr1"). It is **highly recommended** to spcifiy `ref_version` if you are using these three versions. The valid values are: hg19, b37, hg38. 

If you are using a different reference file, please generate the `black_region_bed` file and the `gap_region_bed` file by yourself and specify the `--gap_region_bed` and `--black_region_bed` parameters.

If you don't have samtools and bedtools in your path, please specify the path using `--samtools` and `--bedtools`. 


### <a name="Use_cases"></a> Use cases: 

**Detection of germline SVs from whole-genome sequencing**

```
python linkedsv.py -i input.phased_possorted_bam.bam -d path/to/output_dir/ -r hg38.fa -v hg38 -t 4 --germline_mode
```
The `-v hg38` parameter specify that the reference genome is hg38. If you use another version, please change accordingly. 
We recommend using at least 4 threads to speed up the run. Each thread need 4GB memory.


**Detection of germline SVs from targeted sequencing (e.g. whole-exome sequencing)**

```
python linkedsv.py -i phased_possorted_bam.bam -d path/to/output_dir/ -r ref.fasta -v hg38 -t 4 --targeted --target_region path/to/target_region.bed --germline_mode
```

`target_region.bed` is a bed file that contains the target regions (capture regions). 

**Detection of somatic SVs from whole-genome sequencing** 

```
python linkedsv.py -i input.phased_possorted_bam.bam -d path/to/output_dir/ -r ref.fasta -v hg38 -t 4 --somatic_mode
```


## <a name="Output"></a> Output Files

LinkedSV will output the SV calls, as well as the figures that allow you to visualize the call. 

### <a name="SV_call_file"></a> SV call file

LinkedSV will output two SV call files, `prefix.raw_svcalls.bedpe` and `prefix.filtered_svcalls.bedpe`. The `prefix.raw_svcalls.bedpe` file contains a raw, unfiltered, highly sensitive callset in BEDPE format. and may contain many false positives calls. The `prefix.filtered_svcalls.bedpe` file contains the filtered SV calls. In most cases, you only need to look at the `prefix.filtered_svcalls.bedpe`. 

The BEDPE format was defined by BEDtools (https://bedtools.readthedocs.io/en/latest/content/general-usage.html). It can be used to concisely describe disjoint genome features, such as structural variations. We did not use BED format because BED format does not allow inter-chromosomal feature definitions.

The `prefix.filtered_svcalls.bedpe` file contains one SV per line with the following tab-delimited columns:

|Column|Description|
:----:|:-----------------------------------------|
|chrom1|chrom of breakpoint 1|
|start1|start position of breakpoint 1|
|stop1|end position of breakpoint 1|
|chrom2|chrom of breakpoint 2|
|start2|start position of breakpoint 2|
|stop2|end position of breakpoint 2|
|sv_type|SV type inferred from breakpoints|
|sv_id|unique ID of the SV|
|sv_length|SV length|
|filter|filter. 'PASS' if the call passed all filtering steps.| 
|num_supporting_fragments|number of fragment pairs that support the SV|
|num_supporting_read_pairs|number of read pairs that support the SV|
|endpoint1_type|type of enriched fragment endpoint near breakpoint 1|
|endpoint2_type|type of enriched fragment endpoint near breakpoint 2|
|qual_score|quality score of the SV|
|supporting_barcodes|barcode sequences of the fragments that support the SV|

For the meaning of "endpoint1_type" and "endpoint2_type", please refer to our manuscript ([Citation](#Citation))

### <a name="Intermediate_files"></a> Intermediate files

LinkedSV also output some intermediate files:

```
prefix.bcd21.gz
prefix.bcd13
prefix.read_depth.txt
```

These files contains the data that can be used to visualize the SV evidence. 

## <a name="Visualization"></a> Visualization of SV calls



## <a name="Citation"></a> Citation
If you use LinkedSV in your work, please cite:
> Li Fang, Charlly Kao, Michael V Gonzalez, Fernanda A Mafra, Renata Pellegrino da Silva, Mingyao Li, Soren Wenzel, Katharina Wimmer, Hakon Hakonarson, Kai Wang. LinkedSV: Detection of mosaic structural variants from linked-read exome and genome sequencing data. bioRxiv 409789; doi: https://doi.org/10.1101/409789

## <a name="Getting_Help"></a> Getting Help

Please use the [GitHub's Issues page](https://github.com/WGLab/LinkedSV/issues) if you have questions.
